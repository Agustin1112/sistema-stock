{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row my-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h2>üìä Dashboard</h2>
      <div>
        {% if current_user.is_staff() %}
          <a class="btn btn-sm btn-success" href="#" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">+ Producto</a>
        {% endif %}
        {% if current_user.is_admin() %}
          <a class="btn btn-sm btn-primary" href="{{ url_for('usuarios') }}">Gestionar Usuarios</a>
        {% endif %}
      </div>
    </div>
  </div>

 
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card p-3">
        <small class="text-muted">Total productos</small>
        <h3>{{ total_productos }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <small class="text-muted">Total categor√≠as</small>
        <h3>{{ total_categorias }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <small class="text-muted">Productos en alerta</small>
        <h3>{{ bajo_stock|length }}</h3>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <small class="text-muted">Movimientos totales</small>
        <h3>{{ total_movimientos }}</h3>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- TABLA BAJO STOCK -->
    <div class="col-lg-4">
      <div class="card p-3">
        <h5>Productos en bajo stock</h5>
        <table class="table table-sm">
          <thead>
            <tr><th>Nombre</th><th>Categor√≠a</th><th>Stock</th><th>M√≠nimo</th></tr>
          </thead>
          <tbody>
            {% for p in bajo_stock %}
              <tr>
                <td>{{ p.nombre }}</td>
                <td>{{ p.categoria.nombre }}</td>
                <td>{{ p.stock }}</td>
                <td>{{ p.minimo }}</td>
              </tr>
            {% else %}
              <tr><td colspan="4">No hay productos en alerta.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    
    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <h5>Movimientos √∫ltimos 14 d√≠as</h5>
        <canvas id="chartMovs" height="120"></canvas>
      </div>

      <div class="card p-3">
        <h5>Stock por categor√≠a</h5>
        <canvas id="chartCategorias" height="120"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-4">
    
    <div class="col-lg-8">
      <div class="card p-3">
        <h5>√öltimos movimientos</h5>
        <table class="table table-striped table-sm">
          <thead><tr><th>Fecha</th><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Usuario</th></tr></thead>
          <tbody>
            {% for m in ultimos_mov %}
              <tr>
                <td>{{ m.fecha.strftime("%d/%m %H:%M") }}</td>
                <td>{{ m.producto.nombre if m.producto else "‚Äî" }}</td>
                <td>{{ m.tipo }}</td>
                <td>{{ m.cantidad }}</td>
                <td>{{ m.usuario or "-" }}</td>
              </tr>
            {% else %}
              <tr><td colspan="5">Sin movimientos a√∫n.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    
    <div class="col-lg-4">
      <div class="card p-3">
        <h5>Usuarios ({{ usuarios_count }})</h5>
        {% if current_user.is_admin() %}
          <a class="btn btn-sm btn-outline-primary mb-2" href="{{ url_for('register') }}">Crear usuario</a>
          <table class="table table-sm">
            <thead><tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
            <tbody>
              {% for u in User.query.order_by(User.username).limit(10).all() %}
                <tr>
                  <td>{{ u.username }}</td>
                  <td>{{ u.role }}</td>
                  <td>
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('editar_usuario', id=u.id) }}">Editar</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted">Solo admins pueden ver/gestionar usuarios.</p>
        {% endif %}
      </div>

      <div class="card p-3 mt-3">
        <h6>Panel r√°pido</h6>
        <div class="d-grid gap-2">
          {% if current_user.is_staff() %}
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">Agregar producto</button>
          {% endif %}
          {% if current_user.is_admin() %}
            <a class="btn btn-sm btn-danger" href="{{ url_for('auditoria') }}">Ver auditor√≠a</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

 
  <div class="modal fade" id="modalAgregarProducto" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('agregar_producto') }}" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Agregar producto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><label class="form-label">Nombre</label><input name="nombre" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Categor√≠a</label>
            <select name="categoria_id" class="form-select" required>
              {% for c in Categoria.query.order_by(Categoria.nombre).all() %}
                <option value="{{ c.id }}">{{ c.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2 row">
            <div class="col"><label class="form-label">Stock inicial</label><input name="stock" type="number" class="form-control" value="0"></div>
            <div class="col"><label class="form-label">M√≠nimo</label><input name="minimo" type="number" class="form-control" value="1"></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary">Agregar</button></div>
      </form>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  
  const dias = {{ dias | tojson }};
  const movs_by_day = {{ movs_by_day | tojson }};

  new Chart(document.getElementById('chartMovs'), {
    type: 'line',
    data: {
      labels: dias,
      datasets: [{
        label: 'Movimientos',
        data: movs_by_day,
        fill: true,
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });

  // Stock por categor√≠a (resumen)
  const resumen = {{ resumen | tojson }};
  const cats = Object.keys(resumen);
  const stocks = Object.values(resumen);

  new Chart(document.getElementById('chartCategorias'), {
    type: 'bar',
    data: {
      labels: cats,
      datasets: [{ label: 'Stock', data: stocks }]
    },
    options: { responsive: true }
  });
</script>
{% endblock %}
